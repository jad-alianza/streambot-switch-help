@general
Feature: test-project streaming solution

  Background:
    Given access to the following AWS account and environment and role:
      | account       | profile | region    | role                |
      | 687288345179  | Labs    | us-east-2 | RoleDataTeamDefault |

  @not_implemented
  Scenario: Test foo_bar transformation
    Given AWS Athena table q2_test_project_stream.foo_bar exists
    And there is no test data generated by the previous runs of AQA tests in the following partition:
      | partition_id  | _row_format | _year         | _month        | _day        |
      | q2_aqa_test   | parquet     | <today_year>  | <today_month> | <today_day> |
    And the following AWS SNS topic exists:
      | name                    | parameters  |
      | q2-temp-aqa-lab-foo-bar |             |
    And there is Kinesis Firehose subscription to that SNS topic
      | topic                   | kinesis ARN                                                                                   | SubscriptionRoleArn                                                                             |
      | q2-temp-aqa-lab-foo-bar | arn:aws:firehose:us-east-2:687288345179:deliverystream/q2-streaming-test-project-core-foo-bar | arn:aws:iam::687288345179:role/q2-streaming-test-project-RoleDeliveryStreamSubscr-15XY6A08SED48 |
    When the message as in foo_bar_data.json is sent to SNS topic q2-temp-aqa-lab-foo-bar
    Then the message is processed by the Amazon Kinesis Delivery Stream 'q2-streaming-test-project-core-foo-bar' and is sent to the 'q2-test-project-foo-bar-transformer' lambda
    And the message is transformed by the 'q2-test-project-foo-bar-transformer' lambda
    And the following data appears in the 'q2_test_project_stream.foo_bar' Athena table:
      | partition_id  | column1 | columnN  | event_on                | _keys     | _sequence                                                     | _metadata                                                                                                                                                | _date       | _row_format | _year         | _month        | _day        |
      | q2_aqa_test   | value1  | true     | 2022-11-23 09:04:52.257 | [column1] | {cols=[event_on, _metadata.sent_timestamp], ops=[desc, desc]} | {action=UPSERT, object_type=foo_bar, sent_timestamp=1669194292257, arrival_timestamp=1669194292310, transform_timestamp=1669194354928, stream_lag=62669} | <today_iso> | parquet     | <today_year>  | <today_month> | <today_day> |

  @not_implemented
  Scenario: Test snapshotter processes foo_bar and foo_bar2 data
    Given AWS Athena table q2_test_project_stream.foo_bar exists
    And there is no test data generated by the previous runs of AQA tests in the following partition:
      | partition_id  | _row_format | _year             | _month            | _day            |
      | q2_aqa_test   | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
    And AWS Athena table q2_test_project_stream.foo_bar2 exists
    And there is no test data generated by the previous runs of AQA tests in the following partition:
      | partition_id  | _row_format | _year             | _month            | _day            |
      | q2_aqa_test   | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
    And AWS Athena table q2_test_project_snap.foo_bar exists
    And there is no test data generated by the previous runs of AQA tests in the following partition:
      | partition_id  | _row_format | _year             | _month             | _day            |
      | q2_aqa_test   | parquet     | <yesterday_year>  | <yesterday_month>  | <yesterday_day> |
      | q2_aqa_test   | parquet     | <today_year>      | <today_month>      | <today_day>     |
      |               | parquet     | <today_year>      | <today_month>      | <today_day>     |
    And AWS Athena table q2_test_project_snap.foo_bar2 exists
    And there is no test data generated by the previous runs of AQA tests in the following partition:
      | partition_id  | _row_format | _year             | _month             | _day            |
      | q2_aqa_test   | parquet     | <yesterday_year>  | <yesterday_month>  | <yesterday_day> |
      | q2_aqa_test   | parquet     | <today_year>      | <today_month>      | <today_day>     |
      |               | parquet     | <today_year>      | <today_month>      | <today_day>     |
    And there is the following data in q2_test_project_stream.foo_bar table:
      | id                      | name  | account_id    | partition_id  | language_tag  | email_addresses                   | change_on               | delete_on               | acting_party                                                  | _keys   | _sequence                                                       | _delete                         | _metadata                                                                                                                                                                                                                                                                                    | create_on               | _row_format | _year             | _month            | _day            |
      # CREATE FOR PREVIOUS DAYS
      | m8bGFUctRZa1Zn_xxxxx02  | bob   | acc-xxxxx-002 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 12:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000001, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 12:02:52.230 | parquet     | 2022              | 06                | 07              |
      # CREATE ONLY
      | m8bGFUctRZa1Zn_0000000  | bob   | acc-00000-000 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-19 12:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000001, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-19 12:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # CREATE AND UPDATE with different sequence number
      | m8bGFUctRZa1Zn_0000002  | bob   | acc-00000-002 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 13:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000001, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 13:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | m8bGFUctRZa1Zn_0000002  | new   | acc-00000-002 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 13:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000002, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # CREATE AND TWO UPDATES
      | m8bGFUctRZa1Zn_0000001  | bob   | acc-00000-001 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 10:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000003, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 10:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | m8bGFUctRZa1Zn_0000001  | new   | acc-00000-001 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-21 12:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000004, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # CREATE AND DELETE
      | m8bGFUctRZa1Zn_0000003  | bob   | acc-00000-003 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 08:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000006, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 08:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | m8bGFUctRZa1Zn_0000003  | new   | acc-00000-003 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 15:02:52.230 | 2022-05-20 15:02:52.230 | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000007, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # THERE IS ALREADY DATA IN SNAP TABLE FOR THE FOLLOWING ID
      | m8bGFUctRZa1Zn_0000005  | new   | acc-00000-005 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 18:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000015, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | m8bGFUctRZa1Zn_0000004  | bob   | acc-00000-004 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 14:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000014, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 14:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | m8bGFUctRZa1Zn_0000004  | new   | acc-00000-004 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 14:03:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000015, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # UPDATE ONLY
      | m8bGFUctRZa1Zn_0000007  | bob   | acc-00000-007 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 20:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000030, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # DELETE ONLY
      | m8bGFUctRZa1Zn_0000008  | bob   | acc-00000-008 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 20:02:52.230 | 2022-05-20 20:02:52.230 | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000040, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
    And there is the following data in q2_test_project_stream.foo_bar2 table:
      | account_id    | partition_id  | caller_id    | enabled | change_on               | delete_on               | acting_party                                                                | _keys                           | _sequence                                                       | _delete                         | _metadata                                                                                                                                                                                                                                                                | create_on               | _row_format | _year             | _month            | _day            |
      # CREATE FOR PREVIOUS DAYS
      | acc-xxxxx-002 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 12:02:52.230 |                         | {id=user-0000-1000, account_id=acc-xxxxx-002, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=1, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 12:02:52.230 | parquet     | 2022              | 05                | 20              |
      # CREATE ONLY
      | acc-00000-000 | q2_aqa_test   | 18192223344  | true    | 2022-05-19 12:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-000, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=1, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-19 12:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # CREATE AND UPDATE with different sequence number
      | acc-00000-002 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 13:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-002, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=1, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 13:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | acc-00000-002 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 13:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-002, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=2, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # CREATE AND TWO UPDATES
      | acc-00000-001 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 10:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-001, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=3, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 10:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | acc-00000-001 | q2_aqa_test   | 18192223344  | true    | 2022-05-21 12:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-001, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=4, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # CREATE AND DELETE
      | acc-00000-003 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 08:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-003, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=6, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 08:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | acc-00000-003 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 15:02:52.230 | 2022-05-20 15:02:52.230 | {id=user-0000-1000, account_id=acc-00000-003, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=7, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # THERE IS ALREADY DATA IN SNAP TABLE FOR THE FOLLOWING ACCCOUNT_ID
      | acc-00000-005 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 18:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-005, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=15, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | acc-00000-004 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 14:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-004, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=14, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 14:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | acc-00000-004 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 14:03:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-004, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=15, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # UPDATE ONLY
      | acc-00000-007 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 20:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-007, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=30, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      # DELETE ONLY
      | acc-00000-008 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 20:02:52.230 | 2022-05-20 20:02:52.230 | {id=user-0000-1000, account_id=acc-00000-008, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=40, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
    And there is the following data in q2_test_project_snap.foo_bar table:
      | id                      | name  | account_id    | partition_id  | language_tag  | email_addresses                   | change_on               | delete_on               | acting_party                                                  | _keys   | _sequence                                                       | _delete                         | _metadata                                                                                                                                                                                                                                                                                    | create_on               | _row_format | _year             | _month            | _day            |
      | m8bGFUctRZa1Zn_0000004  | bob   | acc-00000-004 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 14:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000014, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 14:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | m8bGFUctRZa1Zn_0000005  | bob   | acc-00000-005 | q2_aqa_test   | en-US         | ['alianza.automation@gmail.com']  | 2022-05-20 17:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | ['id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000013, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 17:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
    And there is the following data in q2_test_project_snap.foo_bar2 table:
      | account_id    | partition_id  | caller_id    | enabled | change_on               | delete_on               | acting_party                                                                | _keys                           | _sequence                                                       | _delete                         | _metadata                                                                                                                                                                                                                                                                | create_on               | _row_format | _year             | _month            | _day            |
      | acc-00000-004 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 14:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-004, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=14, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 14:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
      | acc-00000-005 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 17:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-005, partition_id=part-00000-001}  | ['account_id', 'partition_id']  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=13, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 17:02:52.230 | parquet     | <yesterday_year>  | <yesterday_month> | <yesterday_day> |
    When it is 00.05AM everyday
    Then q2-test-project-daily-snapshotter lambda starts
    And the following data appears in the 'q2_test_project_snap.foo_bar' Athena table:
      | id                      | name  | account_id    | partition_id  | language_tag  | email_addresses                 | change_on               | delete_on               | acting_party                                                  | _keys | _sequence                                                       | _delete                         | _metadata                                                                                                                                                                                                                                                                                    | create_on               | _row_format | _year         | _month        | _day        |
      | m8bGFUctRZa1Zn_0000000  | bob   | acc-00000-000 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-19 12:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000001, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-19 12:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000002  | new   | acc-00000-002 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-20 13:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000002, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 13:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000001  | new   | acc-00000-001 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-21 12:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000004, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 10:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000003  | new   | acc-00000-003 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-20 15:02:52.230 | 2022-05-20 15:02:52.230 | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000007, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 08:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000004  | new   | acc-00000-004 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-20 14:03:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000015, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 14:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000005  | new   | acc-00000-005 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-20 18:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000015, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 17:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000007  | bob   | acc-00000-007 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-20 20:02:52.230 |                         | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000030, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <today_year>  | <today_month> | <today_day> |
      | m8bGFUctRZa1Zn_0000008  | bob   | acc-00000-008 | q2_aqa_test   | en-US         | [alianza.automation@gmail.com]  | 2022-05-20 20:02:52.230 | 2022-05-20 20:02:52.230 | {id=d4P4dTIBQ4KtTjVwfog1dg, account_id=null, partition_id=1}  | [id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar, trace_id=1b15284c-2365-4ae7-aaf2-97a2ecb5019c, reason=event, region=us-east-2, sequence_number=171056200000000000000000040, dispatch_on=2022-06-07 06:02:34.578, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <today_year>  | <today_month> | <today_day> |
    And the following data appears in the 'q2_test_project_snap.foo_bar2' Athena table:
      | account_id    | partition_id  | caller_id    | enabled | change_on               | delete_on               | acting_party                                                                | _keys                       | _sequence                                                       | _delete                         | _metadata                                                                                                                                                                                                                                                                | create_on               | _row_format | _year         | _month        | _day        |
      | acc-00000-000 | q2_aqa_test   | 18192223344  | true    | 2022-05-19 12:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-000, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=CREATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=1, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-19 12:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-002 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 13:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-002, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=2, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 13:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-001 | q2_aqa_test   | 18192223344  | true    | 2022-05-21 12:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-001, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=4, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 10:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-003 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 15:02:52.230 | 2022-05-20 15:02:52.230 | {id=user-0000-1000, account_id=acc-00000-003, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddblocal, sequence_number=7, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 08:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-004 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 14:03:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-004, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=15, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 14:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-005 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 18:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-005, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=15, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  | 2022-05-20 17:02:52.230 | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-007 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 20:02:52.230 |                         | {id=user-0000-1000, account_id=acc-00000-007, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=UPDATE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=30, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <today_year>  | <today_month> | <today_day> |
      | acc-00000-008 | q2_aqa_test   | 18192223344  | true    | 2022-05-20 20:02:52.230 | 2022-05-20 20:02:52.230 | {id=user-0000-1000, account_id=acc-00000-008, partition_id=part-00000-001}  | [account_id, partition_id]  | {cols=[change_on, _metadata.sequence_number], ops=[desc, desc]} | {col=delete_on, type=timestamp} | {action=DELETE, object_type=foo-bar2, trace_id=c88335a8-3bf0-1bf7-e2bb-2efca7335d14, reason=api-request, region=ddbloca, sequence_number=40, dispatch_on=2022-05-20 12:02:52.169, arrival_timestamp=1660905536293, transform_timestamp=1660905599213, stream_lag=62942}  |                         | parquet     | <today_year>  | <today_month> | <today_day> |
